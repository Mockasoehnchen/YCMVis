<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>First Test</title>
<!-- including ECharts file -->
    <!--"http://echarts.baidu.com/dist/echarts.min.js"> -->
<script src="echarts.min.js"></script>
<!-- including jQuery file -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- including data file -->
<script src="data.js"></script>
<!-- include styles -->
<link rel="stylesheet" type="text/css" href="mystyle.css">
</head>

<body>
	<!-- preparing a DOM for ECharts -->
	<div id='main' class="flex-container">
		<div id='graph' class="graph-container"></div>
		<div id='info-box' class="info-container"></div>
	</div>


	<script type="text/javascript">
		var info_box = document.getElementById('info-box');
		window.addEventListener('resize', resize, false);
		// Resize function
		function resize() {
			setTimeout(function() {
				// Resize chart
				myChart.resize();
			}, 200);
		}

		//based on prepared DOM, initialize echarts instance
		var myChart = echarts.init(document.getElementById('graph'));


		var hidden_alpha = 1; 
		var hidden_nodes= ['ATP','ADP']; //nodes to be reduced in visibility //TODO
		function prepare(){
		    jQuery.each( data,function(j,sp){
		    	var to_color = { }
		    	i=0
		    	jQuery.each(compartments, function(com,dat) {
		    		to_color[com]= get_disitnct_color_kelly(i);
		    		i+=1;
		    	})
		    	modulelist = ['CDC_core', 'GEX_APC', 'GEX_GRN', 'GEX_TRL', 'MET_CCM', 'MET_CWS', 'MET_DNA', 'TRP_ION', 'TRP_NUT', 'VOL_core_growth_single_vol']
		    	jQuery.each(modulelist, function(index,elem) {
		    		to_color[elem]= get_disitnct_color_kelly(index);
		    	})
		    	itemStyle = {
		    		'normal': {},
		    		'emphasis': {}
		    	};
		    	//add colours to nodes		    	
	    		itemStyle.normal.color = to_color[sp['module'][0]] //sp['compartment']]; //TODO: only based on compartments for testing. use modules later
	    		/*
	    		if(! sp['compartment'] in to_color) {
	    			itemStyle.normal.color = 'black';
	    		}
	    		if('compartments' in sp){
	    			if(sp['compartments'].length==1) {
	    				itemStyle.normal.color = to_color[sp['compartments'][0]];
	    			}

	    		} */
	    		
		    	
		    	//remove labels from reactions
		        if(sp['symbol']=='rect'||sp['symbol']=='triangle'){ 
		            sp['label']={
		                normal: {
		                    show: false
		                }
		            };
		            
		        }

		        //reduce visibility of certain nodes
		        if(hidden_nodes.indexOf(sp['name_alt'])>-1){ 
		        	//var color = to_color[sp['compartment']];
					//color = 'rgba'+color.split('rgb')[1].split(')')[0]+', '+String(hidden_alpha)+')';
					//color = 
					//TODO
					//itemStyle.normal.color = color;
					//itemStyle.emphasis.color = to_color[sp['compartment']];
		        }
		        sp['itemStyle'] =itemStyle;

		    })
		    //reduce visibility of links connected to certain nodes
		    jQuery.each( links,function(j,link){ 
					if(hidden_nodes.indexOf(link['target_alt'])>-1){ //hidden_nodes.indexOf(link['source'])>-1
						/*
						link['lineStyle']= {
							//todo
						}
						*/
					}
		    })
		    //create compartment nodes
		    
		    jQuery.each( compartments,function(name,compartment){
		    	data.push({ 
		    		name: name,
		    		symbol: 'roundRect',
		    		//'symbolSize': compartment.symbolSize , 
		    		module: compartment.module,
		    		x: 0, //todo
		    		y: 0,
		    		open: 0
		    	})
		    	//create invisible links to all nodes in the compartment //only used for force layout?
		    	/*
		    	jQuery.each(compartment.species,function(index, value){
		    		links.push({
		    			target: value,
		    			source: name,
		    			target_alt: value,
		    			source_alt: name,
		    			lineStyle: {
		    				opacity: 0
		    			}
		    			
		    		})
		    	})
		    	*/
		    	
		    }) 
		    /*
		    data.push({ 
		    		name: 'testnode1',
		    		symbol: 'roundRect',
		    		//'symbolSize': compartment.symbolSize , 
		    		module: 'any',
		    		x: 100, //todo
		    		y: 100
		    })
		    data.push({ 
		    		name: 'testnode2',
		    		symbol: 'roundRect',
		    		//'symbolSize': compartment.symbolSize , 
		    		module: 'any',
		    		x: 200, //todo
		    		y: 100
		    })
		    data.push({ 
		    		name: 'testnode3',
		    		symbol: 'roundRect',
		    		//'symbolSize': compartment.symbolSize , 
		    		module: 'any',
		    		x: 100, //todo
		    		y: 200
		    })
		    links.push({
		    			targets: ['testnode1','testnode2'] ,
		    			source: 'testnode3',
		    			target_alt:'testnode1' ,
		    			source_alt: 'testnode3',
		    			lineStyle: {
		    				opacity: 1
		    			}
		    			
		    })*/
		    
		}
        prepare();
		//specific chart configuration item and data
		var option = {
			title : {
				text : 'First javascript and ECharts test'
			},
			tooltip : {
				show: false
			},

			series : [{
				name : 'YCM',
				type : 'graph',
				layout : 'none',//'circular',//'force',
				symbolSize : get_symbolSize(),
				roam : true,
				draggable: true,
				
				label: {
					
					normal: { //TODO: only show label if node big enough, otherwise show tooltip with name
						show: false,
						formatter: function(data){
							var s = data.data['name_alt'];
							return s
						}
					}
					
				},
				//focusNodeAdjacency: true, //TODO: implement own version to avoid weird labels
				edgeSymbol : [ 'none', 'arrow' ],
				edgeSymbolSize : get_symbolSize(),
                lineStyle: { 
                    normal: {
                        color: 'source',
                        curveness: 0.0,
                        type: 'solid',
                        width: 2
                    } 
                },
				data : data,
				links : links
			}]
		};

		myChart.setOption(option);


		
		//higlighting rework TODO
		myChart.on('mouseover', function(params) {
			if (params.componentType === 'series') {
				if (params.seriesType === 'graph') {
					if (params.dataType === 'edge') {
						//  over an edge of the graph
						//myChart.dispatchAction({type: 'highlight'}) //TODO

					} else {
						// over a node of the graph
						myChart.dispatchAction({type: 'focusNodeAdjacency', seriesIndex: params.seriesIndex, dataIndex: params.dataIndex});
					}
				}
			}
		});
		myChart.on('mouseout', function(params) {
			if (params.componentType === 'series') {
				if (params.seriesType === 'graph') {
					if (params.dataType === 'edge') {
						//  over an edge of the graph
						//myChart.dispatchAction({type: 'highlight'}) //TODO

					} else {
						// over a node of the graph
						myChart.dispatchAction({type: 'unfocusNodeAdjacency', seriesIndex: params.seriesIndex, dataIndex: params.dataIndex});
					}
				}
			}
		});
		


		//mouse click eventhandling
		var current_infoelement = 'none';
		myChart.on('click', function(params) {
			if (params.componentType === 'series') {
				if (params.seriesType === 'graph') {
					if (params.dataType === 'edge') {
						// clicked on an edge of the graph
					} else {
						// clicked on a node of the graph
						
						if (params.data.hasOwnProperty('open')) { //compartment
							if(params.data.open == 0){
								openCompartment(params);
							}
							else{
								closeCompartment(params)
							}
						} else {
							if (current_infoelement == 'none') {
								show_info(params.data);
							} else {
								if (current_infoelement != params.data.name) {
									show_info(params.data);

								} else {
									hide_info();
								}

							}
						}
						myChart.resize();

					}
				}
			}
		});

		function openCompartment(param) {
			//TODO: much
			
			redraw();

		}

		function closeCompartment(param) {
			//TODO

			redraw();
		}

		function redraw() {

			myChart.setOption({
				series : [ {
					data : data,
					links : links,
				} ]
			});
		}

		function show_info(param) {
			info_box.style.width = '40%';
			var text = param.name_alt + '<br>';
			if (param.hasOwnProperty('module')) {
				text += 'Module: '+param.module+'<br>';
			}
			if (param.hasOwnProperty('compartment')) {
				text += 'Compartment: '+param.compartment+'<br>';
			}
			if (param.hasOwnProperty('compartments')) {
				text += 'Compartments: '+param.compartments+'<br>';
			}

			if (param.hasOwnProperty('state')) {
				text += 'State: '+param.state+'<br>';
			}
			if (param.hasOwnProperty('rate')) {
				//TODO: autoconvert to MathML???
				text += 'Rate: '+param.rate+'<br>';
			}
			if (param.hasOwnProperty('equation')) {
				text += 'Equation: '+param.equation+'<br>';
			}
			if (param.hasOwnProperty('annotation')) {
				var annoList =  param.annotation.split('_');
				text += 'Annotation: ';
				var address= '';
				jQuery.each(annoList,function(index,anno){
					
					address= '';
					if(anno.startsWith('CHEBI:')) {
						text += '<a href= ';
						address= 'http://www.ebi.ac.uk/chebi/searchId.do?chebiId='+anno;
						text+=address+'>'+anno+'</a><br>';
					}
					else if(anno.startsWith('SBO:')){
						text += '<a href= ';
						address= 'http://www.ebi.ac.uk/sbo/main/'+anno;
						text+=address+'>'+anno+'</a><br>';
						
					}
					else if(anno.startsWith('SGD:')){
						text += '<a href= ';
						address= 'https://www.yeastgenome.org/locus/'+anno.slice(4,anno.length-1);
						if (anno.endsWith('p')){
							address+='/protein';
						}
						text+=address+'>'+anno+'</a><br>';
					}
					else {
						text+= anno+'<br>';
					}

				})
				if (address !=''){
					text+= "<iframe src="+address+" flex-grow: 1 weidth= 100% height= 100%></iframe>"
				}
				
				
			}
			info_box.innerHTML = text;
			current_infoelement = param.name;
		}
		function hide_info() {
			info_box.style.width = '0%';
			info_box.innerHTML = '';
			current_infoelement = 'none';
		}


		function get_symbolSize(value,params) {
			return 5; //todo: used later when integrating information from simulations
		}

		function get_disitnct_color_kelly(number){
			var kelly_colors = [
					//white //already background
					'rgb(0 , 0, 0)',//black
					'rgb(255, 179, 0)', //vivid_yellow
                    'rgb(128, 62, 117)', //strong_purple
                    'rgb(255, 104, 0)', //vivid_orange
                    'rgb(166, 189, 215)',// very_light_blue
                    'rgb(193, 0, 32)', //vivid_red
                    'rgb(206, 162, 98)', //grayish_yellow
                    'rgb(129, 112, 102)', //medium_gray

                    // these aren't good for people with defective color vision:
                    'rgb(0, 125, 52)', //vivid_green
                    'rgb(246, 118, 142)', //strong_purplish_pink
                    'rgb(0, 83, 138)', //strong_blue
                    'rgb(255, 122, 92)', //strong_yellowish_pink
                    'rgb(83, 55, 122)', //strong_violet
                    'rgb(255, 142, 0)', //vivid_orange_yellow
                    'rgb(179, 40, 81)', //strong_purplish_red
                    'rgb(244, 200, 0)', //vivid_greenish_yellow
                    'rgb(127, 24, 13)', //strong_reddish_brown
                    'rgb(147, 170, 0)', //vivid_yellowish_green
                    'rgb(89, 51, 21)', //deep_yellowish_brown
                    'rgb(241, 58, 19)',//vivid_reddish_orange
                    'rgb(35, 44, 22))' //dark_olive_green
				];
			return kelly_colors[number];


		}

	</script>
</body>

</html>