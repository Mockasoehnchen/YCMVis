<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>First Test</title>
<!-- including ECharts file -->
    <!--"http://echarts.baidu.com/dist/echarts.min.js"> -->
<script src="echarts.min.js"></script>
<!-- including jQuery file -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- including data file -->
<script src="data.js"></script>
<!-- include styles -->
<link rel="stylesheet" type="text/css" href="mystyle.css">
</head>

<body>
	<!-- preparing a DOM for ECharts -->
	<div id='main' class="flex-container">
		<div id='graph' class="graph-container"></div>
		<div id='info-box' class="info-container"></div>
	</div>


	<script type="text/javascript">
		var info_box = document.getElementById('info-box');
		window.addEventListener('resize', resize, false);
		// Resize function
		function resize() {
			setTimeout(function() {
				// Resize chart
				myChart.resize();
			}, 200);
		}

		//based on prepared DOM, initialize echarts instance
		var myChart = echarts.init(document.getElementById('graph'));

		function prepare(){ //adjust reaction display
		    jQuery.each( data,function(j,sp){
		        if(sp['symbol']=='rect'){
		            sp['label']={
		                normal: {
		                    show: false
		                }
		            };
		            sp['symbolSize']=20;
		        }
		    })
		}
        prepare();

		//specific chart configuration item and data
		var option = {
			title : {
				text : 'First javascript and ECharts test'
			},
			tooltip : {
				formatter : '{b}'
			},
			animation : true,
			legend : {},
			series : [ {
				name : 'TestGraph',
				type : 'graph',
				layout : 'none',//'circular',//'force',
				symbolSize : 30,
				roam : true,
				label : {
					normal : {
						show : true
					}
				},
				edgeSymbol : [ 'circle', 'arrow' ],
				edgeSymbolSize : [ 4, 10 ],
                lineStyle: {
                    normal: {
                        color: 'source',
                        curveness: 0.0,
                        type: 'solid',
                        width: 3
                    }
                },
				data : data,
				links : links
			} ]
		};

		myChart.setOption(option);

		var current_infoelement = 'none';
		myChart.on('click', function(params) {
			if (params.componentType === 'series') {
				if (params.seriesType === 'graph') {
					if (params.dataType === 'edge') {
						// clicked on an edge of the graph
					} else {
						// clicked on a node of the graph
						
						if (false) { //TODO
							openCompartment(params);
						} else {
							if (current_infoelement == 'none') {
								show_info(params.data);
							} else {
								if (current_infoelement != params.data.name) {
									show_info(params.data);

								} else {
									hide_info();
								}

							}
						}
						myChart.resize();

					}
				}
			}
		});

		function openCompartment(param, index) {
			//TODO: much

			redraw();

		}

		function closeCompartment(param) {
			//TODO

			redraw();
		}

		function redraw() {
			gra = createVisibleGraph(data);
			data = gra[0];
			links = gra[1];

			myChart.setOption({
				series : [ {
					data : data,
					links : links,
				} ]
			});
		}

		function show_info(param) {
			info_box.style.width = '40%';
			var text = param.name + '<br>';
			if (param.hasOwnProperty('module')) {
				text += 'Module: '+param.module+'<br>';
			}
			if (param.hasOwnProperty('compartment')) {
				text += 'Compartment: '+param.compartment+'<br>';
			}

			if (param.hasOwnProperty('state')) {
				text += 'State: '+param.state+'<br>';
			}
			if (param.hasOwnProperty('rate')) {
				text += 'Rate: '+param.rate+'<br>';
			}
			if (param.hasOwnProperty('annotation')) {
				//text += 'Annotation: '+param.annotation+'<br>';
				//text += 'Web: ';
				if(param.annotation.startsWith('CHEBI:')) {
					var address= 'http://www.ebi.ac.uk/chebi/searchId.do?chebiId='+param.annotation;
					text+=address+'<br>';
					text+= "<iframe src="+address+" flex-grow: 1 weidth= 100% height= 100%></iframe>"
					//document.getElementById('inner_info').innerHTML = "";
				}
			}
			info_box.innerHTML = text; //TODO: show data
			current_infoelement = param.name;
		}
		function hide_info() {
			info_box.style.width = '0%';
			info_box.innerHTML = '';
			current_infoelement = 'none';
		}
	</script>
</body>

</html>